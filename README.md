# X-BASIC to C コンバータ bas2c.py

## 概要

X680x0 の C Compiler PRO-68K (XC) には BAStoC (BC.X) というコンバータが付属していて、X-BASIC のソースコードを C 言語に変換してコンパイルすることで高速化できたのですが、
残念ながら [無償公開されている XC](http://retropc.net/x68000/software/sharp/xc21/) からは削除されています。

このプログラムは BC.X の代替を目指して、X-BASIC のソースコードを C 言語に変換する Python スクリプトです。
クロス開発環境 [elf2x68k](https://github.com/yunkya2/elf2x68k) と組み合わせて利用することを想定していますが、[MicroPython for X68000](https://github.com/yunkya2/micropython-x68k/blob/port-x68k/ports/x68k/README.md) 上でも動作するので、実機上での変換もできないことはないです (ただしめちゃくちゃ遅いです…)。

## 使い方

Linux (WSL) や MSYS2 等、Python3 が動作する環境で使用します。

### X-BASIC → C の変換

bas2c.py と bas2c.def をパスの通った同じディレクトリに置いて、以下のように実行します。
```
bas2c.py [<オプション>] [<BASICソースコード>.bas] [-o <Cソースコード>.c]
```

<Cソースコード> の指定を省略すると、BASICソースコードの拡張子を .c に変更したファイル名を使用します。
<BASICソースコード> の指定を省略すると、標準入力から読み込んだソースコードを変換して標準出力に出力します。

以下の <オプション> が指定できます。

* `-u`
  * ソースコード中に X-BASIC の標準関数や外部関数にない関数呼び出しがあった場合、通常はそれをそのまま出力しますが (BC.X と同じ動作)、このオプションを指定するとエラーにします。
* `-n`
  * 通常、変換後の C ソースコードはプログラムの開始時に `b_init()`、終了時に `b_exit()` を呼び出して X-BASIC としての初期化/終了処理を行いますが、このオプションを指定すると `b_init()` は呼ばず、 `b_exit()` の代わりに `exit()` を呼び出します。
* `-s`
  * 変換後の C ソースコードの文字コードを Shift_JIS にします。デフォルトは UTF-8 です。
  * (変換前の X-BASIC ソースコードは、Shift_JIS か UTF-8 かを自動判別します)
  * MicroPython 上で実行する場合はこのオプション指定は意味を持ちません。入力ソースコードの文字コードがそのまま出力に使われます。
* `-v`
  * 変換中の BASIC ソースコードを標準出力に表示します。
* `-c[TAB数]`
  * 変換後の C ソースコードに BASIC の各行をコメントとして出力します。`TAB数` はコメントのインデントに使うタブの数です。デフォルトは 7 です。

### 変換したコードのコンパイル

bas2c.py で変換したソースコードは、[elf2x68k](https://github.com/yunkya2/elf2x68k) で以下のようにしてコンパイルできます。
```
m68k-xelf-gcc -o <実行ファイル名> <Cソースコード>.c -specs=xc.specs -lbas
```

## bas2c.def について

bas2c.py は、X-BASIC の標準関数や外部関数を C 言語での関数名を変換するために、bas2c.def というファイルを使用します。
BC.X で使われていた *.DEF ファイル (BASIC.DEF, GRAPH.DEF,...) を 1 ファイルにまとめた形になっています。

ファイルは以下のようなフォーマットで記述されています。
```
[<グループ名>]

<BASIC関数の戻り値型> <BASIC関数名>(<BASIC関数引数型...>) : <C関数名>(<C関数引数型...>)
    :
```

<グループ名> は、関数呼び出しが使われた際に必要なヘッダファイルを include するために使われます。
例えば、[GRAPH] グループにある関数 (fill(), line()など) がプログラム中で使われると、変換後の C ソースコードの冒頭に
```
#include <graph.h>
```
が追加されます。
適切な C 関数用ヘッダファイルを用意して bas2c.def に関数定義を追加することで、ユーザーが独自の外部関数を追加することもできます。

(bas2.def の冒頭には最初のグループとして、特殊な変換規則を必要とする関数、ステートメントが定義されています。これらの変換規則は bas2c.py 内の変換ルーチンの記述と連携しているので変更しないようにしてください)

## 制約と注意事項

* X-BASIC と C 言語とでは演算子の優先順位や論理演算の値が異なります(真を表す値は X-BASIC では -1 ですが C 言語では 1 です)。
BC.X はこの違いを考慮せずそのまま C 言語に変換していましたが、bas2c.py はなるべくオリジナルの X-BASIC の挙動を再現するようにしています。
このため、「X-BASIC インタプリタでは動かないが BC.X で変換すると動く」ようなコードは bas2c.py でも動かないかも知れません。
* エラーチェックがかなりいいかげんなので、変換元のソースコードは X-BASIC インタプリタで充分デバッグされたものにしてください。元のコードに不具合がある場合、変換がエラーなしに通っても変換後の C ソースコードのコンパイル時にエラーになることがあります。

## ライセンス

bas2c.py は MIT ライセンスとします。
