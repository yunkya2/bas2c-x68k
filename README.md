# X-BASIC to C コンバータ bas2c.py

## 概要

X680x0 の C Compiler PRO-68K (XC) には BAStoC (BC.X) というコンバータが付属していて、X-BASIC のソースコードを C 言語に変換してコンパイルすることで高速化できたのですが、
残念ながら [無償公開されている XC](http://retropc.net/x68000/software/sharp/xc21/) からは削除されています。

このプログラムは BC.X の代替を目指して、X-BASIC のソースコードを C 言語に変換する Python スクリプトです。
クロス開発環境 [elf2x68k](https://github.com/yunkya2/elf2x68k) と組み合わせて利用することを想定していますが、[MicroPython for X68000](https://github.com/yunkya2/micropython-x68k/blob/port-x68k/ports/x68k/README.md) 上でも動作するので、実機上での変換もできないことはないです (ただしめちゃくちゃ遅いです…)。

## 使い方

Linux (WSL) や MSYS2 等、Python3 が動作する環境で使用します。

### X-BASIC → C の変換

bas2c.py と bas2c.def をパスの通った同じディレクトリに置いて、以下のように実行します。
```
bas2c.py [<オプション>] [<BASICソースコード>.bas] [-o <Cソースコード>.c]
```

<Cソースコード> の指定を省略すると、BASICソースコードの拡張子を .c に変更したファイル名を使用します。
<BASICソースコード> の指定を省略すると、標準入力から読み込んだソースコードを変換して標準出力に出力します。

以下の <オプション> が指定できます。

* `-u`
  * ソースコード中に X-BASIC の標準関数や外部関数にない関数呼び出しがあった場合、通常はそれをそのまま出力しますが (BC.X と同じ動作)、このオプションを指定するとエラーにします。
* `-n`
  * 通常、変換後の C ソースコードはプログラムの開始時に `b_init()`、終了時に `b_exit()` を呼び出して X-BASIC としての初期化/終了処理を行いますが、このオプションを指定すると `b_init()` は呼ばず、 `b_exit()` の代わりに `exit()` を呼び出します。
* `-s`
  * 変換後の C ソースコードの文字コードを Shift_JIS にします。デフォルトは UTF-8 です。
  * (変換前の X-BASIC ソースコードは、Shift_JIS か UTF-8 かを自動判別します)
  * MicroPython 上で実行する場合はこのオプション指定は意味を持ちません。入力ソースコードの文字コードがそのまま出力に使われます。
* `-b`
  * 変換時に、式における X-BASIC と C 言語の仕様の違いに対する補正を行いません。
X-BASIC と BC.X の出力とで結果が異なるようなソースコードを変換する場合、通常は X-BASIC の仕様に合わせるような変換を行いますが、このオプションを指定すると BC.X の出力に近い結果が得られるようになります。
* `-v`
  * 変換中の BASIC ソースコードを標準出力に表示します。
* `-c[TAB数]`
  * 変換後の C ソースコードに BASIC の各行をコメントとして出力します。`TAB数` はコメントのインデントに使うタブの数です。デフォルトは 7 です。

### 変換したコードのコンパイル

bas2c.py で変換したソースコードは、[elf2x68k](https://github.com/yunkya2/elf2x68k) で以下のようにしてコンパイルできます。
```
m68k-xelf-gcc -o <実行ファイル名> <Cソースコード>.c -specs=xc.specs -lbas
```

変換後のソースコードのコンパイルを X68k 実機やエミュレータ上の XC で行う場合は、
```
CC /W <Cソースコード>
```
のように `/W` オプションを付けて、BASIC ライブラリをリンクするようにしてください。

## bas2c.def について

bas2c.py は、X-BASIC の標準関数や外部関数を C 言語での関数名を変換するために、bas2c.def というファイルを使用します。
BC.X で使われていた *.DEF ファイル (BASIC.DEF, GRAPH.DEF,...) を 1 ファイルにまとめた形になっています。

ファイルは以下のようなフォーマットで記述されています。
```
[<グループ名>]

<BASIC関数の戻り値型> <BASIC関数名>(<BASIC関数引数型...>) : <C関数名>(<C関数引数型...>)
    :
```

<グループ名> は、関数呼び出しが使われた際に必要なヘッダファイルを include するために使われます。
例えば、[GRAPH] グループにある関数 (fill(), line()など) がプログラム中で使われると、変換後の C ソースコードの冒頭に
```
#include <graph.h>
```
が追加されます。
適切な C 関数用ヘッダファイルを用意して bas2c.def に関数定義を追加することで、ユーザーが独自の外部関数を追加することもできます。

(bas2.def の冒頭には最初のグループとして、特殊な変換規則を必要とする関数、ステートメントが定義されています。これらの変換規則は bas2c.py 内の変換ルーチンの記述と連携しているので変更しないようにしてください)

## インライン C 言語機能

BC.X には、X-BASIC プログラム中の `#c` から `#endc` で囲まれた行をそのまま C ソースコードとして出力する、という未公開機能があります。
bas2c.py でも同等の機能をサポートしています。

X-BASIC では実現できない処理を C のコードとして記述するのに利用できますが、この機能で出力されるコードは main 関数または func 命令で定義中の関数の中になるため、グローバル変数の定義や #include ディレクティブなど、関数定義の外でないと書けない処理には使用できないことに注意が必要です。

### 例:

X-BASIC プログラム (テキスト VRAM の プレーン0 への書き込み):
```
   10 #c
   20 {
   30 void B_SUPER(int);    /* #includeが使えないので個別にプロトタイプ宣言が必要 */
   40 B_SUPER(0);           /* スーパーバイザモードへ */
   50 }
   60 #endc
   70 for i=&HE00000 to &HE0FFFF
   80 poke(i,&HFF)
   90 next
  100 end
 1000 func poke(a,v)        /* アドレスaに値vを書き込む関数 */
 1010 #c
 1020 *(char *)a = v;
 1030 #endc
 1040 endfunc
```

変換後の C ソースコード
```
/******** program start ********/
void main(int b_argc, char *b_argv[])
{
        b_init();
{                           // #c - #endc の中がそのまま出力される
void B_SUPER(int);          //
B_SUPER(0);                 //
}                           //
        for (i = 0xE00000; i <= 0xE0FFFF; i++) {
                poke(i, 0xFF);
        }
b_exit(0);
}

/***************************/
int poke(int a, int v)
{
*(char *)a = v;             // #c - #endc の中がそのまま出力される
}
```

※ インライン C 言語で DOS コールや IOCS コールを使用した場合は、elf2x68k でのコンパイル時には `-ldos -liocs` 、XC でのコンパイルの際には `/Y` オプション (DOS/IOCSライブラリの使用) を指定してください。

## 制約と注意事項

* BC.X は XC ver.1 の頃から使われていることもあり、出力される C ソースコードの関数定義が (いわゆる) K&R スタイルで書かれていました。
bas2c.py は XC ver.2 や gcc での利用を前提として関数定義を ANSI スタイルで出力します。
その他、配列の初期化などでも BC.X と異なるコードを出力します。
* X-BASIC と C 言語とでは演算子の優先順位や論理演算の値が異なります(例えば、真を表す値は X-BASIC では -1 ですが C 言語では 1 です)。
BC.X はこの違いを考慮せずそのまま C 言語に変換していたため、式の計算結果が X-BASIC と異なることがありました。
bas2c.py では、変換時に必要に応じてカッコを補うことなどにより計算結果が変わらないようにしています。
この挙動は `-b` オプションによって変更できます。

## ライセンス

bas2c.py は MIT ライセンスとします。
